<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PmDataMapper">
	<insert id="insertPmData" parameterType="PmData">
		insert into pmdata(pm25,pm100,time,station)
		values(#{pm25},#{pm100},#{time},#{station}) 
	</insert>
	<select id="PmDataByStation" parameterType="Integer" resultType="PmData">
		select * 
		from pmdata 
		where station = #{station}
	</select>
	<select id="findRecentPmList" parameterType="string" resultType="PmData">
		SELECT
		   st.station_name,
		   st.sido,
			pm.*
		FROM station st
		LEFT JOIN (SELECT
				   pm.seq,
					pm.station,
					MAX(pm.time) AS recent_time
					FROM pmdata pm
					WHERE pm.pm25 IS NOT null 
					AND pm.pm100 IS NOT null
					GROUP BY pm.station
			) rpm
		  ON st.seq = rpm.station
		LEFT JOIN pmdata pm 
		  ON rpm.station = pm.station AND rpm.recent_time = pm.time
		  <if test="sido != null">
			 WHERE sido = #{sido} 
		  </if>
	</select>
</mapper>